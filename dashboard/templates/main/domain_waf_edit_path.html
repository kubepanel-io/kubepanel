{% extends "base.html" %}
{% load static %}

{% block title %}Edit Protected Path - {{ domain.domain_name }} | KubePanel{% endblock %}

{% block page_title %}Edit Protected Path{% endblock %}
{% block page_subtitle %}Modify access restriction for {{ domain.domain_name }}{% endblock %}

{% block breadcrumbs %}
<nav class="flex" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{% url 'kpmain' %}" class="text-gray-500 hover:text-gray-700">Domains</a>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <a href="{% url 'view_domain' domain.domain_name %}" class="ml-1 text-gray-500 hover:text-gray-700">{{ domain.domain_name }}</a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <a href="{% url 'domain_waf_list' domain.domain_name %}" class="ml-1 text-gray-500 hover:text-gray-700">WAF</a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
                <span class="ml-1 text-gray-700 font-medium">Edit Protected Path</span>
            </div>
        </li>
    </ol>
</nav>
{% endblock %}

{% block header_actions %}
<a href="{% url 'domain_waf_list' domain.domain_name %}"
   class="bg-gray-100 text-gray-700 px-4 py-2.5 rounded-lg font-medium hover:bg-gray-200 transition-all duration-200 flex items-center space-x-2">
    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
    </svg>
    <span>Back to WAF</span>
</a>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <form method="POST" id="editProtectedPathForm" class="space-y-6">
        {% csrf_token %}

        <!-- Protection Type Info -->
        <div class="bg-purple-50 rounded-xl border border-purple-200 p-4">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <div>
                    <span class="font-medium text-purple-900">Protected Path</span>
                    <p class="text-sm text-purple-700">Only specified IP or countries can access this path</p>
                </div>
            </div>
        </div>

        <!-- Path Configuration -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Path Configuration</h3>

            <div class="space-y-6">
                <!-- Path -->
                <div>
                    <label for="path" class="block text-sm font-medium text-gray-700 mb-2">
                        Path
                        <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           id="path"
                           name="path"
                           value="{{ protected_path.path|default:'' }}"
                           placeholder="/wp-login.php or /admin"
                           required
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm font-mono">
                    <p class="mt-1 text-sm text-gray-500">The path to protect (e.g., /wp-login.php, /admin)</p>
                </div>

                <!-- Path Match Type -->
                <div>
                    <label for="pathMatchType" class="block text-sm font-medium text-gray-700 mb-2">
                        Match Type
                    </label>
                    <select id="pathMatchType"
                            name="pathMatchType"
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm bg-white">
                        <option value="prefix" {% if protected_path.pathMatchType == "prefix" or not protected_path.pathMatchType %}selected{% endif %}>Prefix (starts with)</option>
                        <option value="exact" {% if protected_path.pathMatchType == "exact" %}selected{% endif %}>Exact match</option>
                        <option value="regex" {% if protected_path.pathMatchType == "regex" %}selected{% endif %}>Regex</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">How to match the path pattern</p>
                </div>
            </div>
        </div>

        <!-- Access Control -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Access Control</h3>
            <p class="text-sm text-gray-500 mb-4">
                Choose who can access this protected path. All other requests will be blocked.
            </p>

            <div class="space-y-6">
                <!-- Allow Type Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Allow Access From</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio"
                                   name="allow_type"
                                   value="ip"
                                   {% if protected_path.allowedIp or not protected_path.allowedCountries %}checked{% endif %}
                                   onchange="toggleAllowType()"
                                   class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">Specific IP Address</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio"
                                   name="allow_type"
                                   value="countries"
                                   {% if protected_path.allowedCountries %}checked{% endif %}
                                   onchange="toggleAllowType()"
                                   class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300">
                            <span class="ml-2 text-sm text-gray-700">Countries</span>
                        </label>
                    </div>
                </div>

                <!-- IP Field -->
                <div id="ipField" class="{% if protected_path.allowedCountries %}hidden{% endif %}">
                    <label for="allowedIp" class="block text-sm font-medium text-gray-700 mb-2">
                        Allowed IP Address
                        <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           id="allowedIp"
                           name="allowedIp"
                           value="{{ protected_path.allowedIp|default:'' }}"
                           placeholder="1.2.3.4 or 10.0.0.0/24"
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm font-mono">
                    <p class="mt-1 text-sm text-gray-500">Single IP or CIDR notation. Only this IP can access the path.</p>
                </div>

                <!-- Countries Field -->
                <div id="countriesField" class="{% if not protected_path.allowedCountries %}hidden{% endif %}">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Allowed Countries
                        <span class="text-red-500">*</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <select id="countryPicker" class="block w-48 rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm">
                            <option value="">Select country...</option>
                            {% for code, name in countries %}
                            <option value="{{ code }}">{{ code }} - {{ name }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" onclick="addCountryToList()" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors">
                            Add
                        </button>
                    </div>
                    <div id="selectedCountries" class="flex flex-wrap gap-2 mt-3">
                        {% for country in protected_path.allowedCountries %}
                        <span id="country-badge-{{ country }}" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            {{ country }}
                            <button type="button" onclick="removeCountryFromList('{{ country }}')" class="ml-2 text-green-600 hover:text-green-800">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </span>
                        {% endfor %}
                    </div>
                    <div id="hiddenCountryInputs">
                        {% for country in protected_path.allowedCountries %}
                        <input type="hidden" name="allowedCountries" value="{{ country }}" id="country-input-{{ country }}">
                        {% endfor %}
                    </div>
                    <p class="mt-2 text-sm text-gray-500">Only requests from selected countries can access this path.</p>
                </div>
            </div>
        </div>

        <!-- Comment -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Description</h3>
            <div>
                <label for="comment" class="block text-sm font-medium text-gray-700 mb-2">
                    Comment
                    <span class="text-gray-400 font-normal">(optional)</span>
                </label>
                <textarea id="comment"
                          name="comment"
                          rows="2"
                          placeholder="Why this path is protected..."
                          class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm resize-none">{{ protected_path.comment|default:'' }}</textarea>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="flex items-center justify-end space-x-4">
            <a href="{% url 'domain_waf_list' domain.domain_name %}"
               class="px-6 py-2.5 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                Cancel
            </a>
            <button type="submit"
                    class="btn-primary text-white px-6 py-2.5 rounded-lg font-medium shadow-sm hover:shadow-md transition-all duration-200">
                Update Protection
            </button>
        </div>
    </form>
</div>

<script>
function toggleAllowType() {
    const allowType = document.querySelector('input[name="allow_type"]:checked').value;
    const ipField = document.getElementById('ipField');
    const countriesField = document.getElementById('countriesField');

    if (allowType === 'ip') {
        ipField.classList.remove('hidden');
        countriesField.classList.add('hidden');
    } else {
        ipField.classList.add('hidden');
        countriesField.classList.remove('hidden');
    }
}

// Track selected countries
const selectedCountryCodes = new Set([{% for country in protected_path.allowedCountries %}'{{ country }}'{% if not forloop.last %}, {% endif %}{% endfor %}]);

function addCountryToList() {
    const picker = document.getElementById('countryPicker');
    const code = picker.value;
    if (!code || selectedCountryCodes.has(code)) {
        picker.value = '';
        return;
    }

    selectedCountryCodes.add(code);

    // Add badge
    const container = document.getElementById('selectedCountries');
    const badge = document.createElement('span');
    badge.id = 'country-badge-' + code;
    badge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
    badge.innerHTML = `
        ${code}
        <button type="button" onclick="removeCountryFromList('${code}')" class="ml-2 text-green-600 hover:text-green-800">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    container.appendChild(badge);

    // Add hidden input
    const inputs = document.getElementById('hiddenCountryInputs');
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'allowedCountries';
    input.value = code;
    input.id = 'country-input-' + code;
    inputs.appendChild(input);

    picker.value = '';
}

function removeCountryFromList(code) {
    selectedCountryCodes.delete(code);
    const badge = document.getElementById('country-badge-' + code);
    if (badge) badge.remove();
    const input = document.getElementById('country-input-' + code);
    if (input) input.remove();
}
</script>
{% endblock %}
